<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¤©æ°”é¢„æµ‹ - é¦™æ¸¯å¤©æ°”é¢„æµ‹å¯è§†åŒ–ç³»ç»Ÿ</title>
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@3.4.1/dist/js/bootstrap.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@3.4.1/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/head.css') }}">
    <style>
        /* ç»Ÿä¸€ä½¿ç”¨é£é€Ÿåˆ†æé¡µé¢çš„æ ·å¼ */
        .header {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 10px 0;
            margin-top: 20px;
        }

        .nav-sidebar {
            display: flex;
            justify-content: center;
            padding: 10px;
            background-color: rgba(75, 85, 192, 0.2);
        }

        .container {
            margin-top: 30px;
        }

        .chart-container {
            width: 100%;
            height: 500px;
            margin: 20px 0;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            padding: 20px;
            border: 1px solid #ddd;
        }

        .loading-status {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
        }

        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }

        .status-loading {
            background-color: #ffc107;
            animation: pulse 1.5s infinite;
        }

        .status-success {
            background-color: #28a745;
        }

        .status-error {
            background-color: #dc3545;
        }

        @keyframes pulse {
            0% {
                opacity: 1;
            }
            50% {
                opacity: 0.5;
            }
            100% {
                opacity: 1;
            }
        }

        .station-controls {
            margin-bottom: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 5px;
        }

        .section-title {
            margin-top: 30px;
            margin-bottom: 15px;
            border-bottom: 1px solid #eee;
            padding-bottom: 10px;
        }

        .data-info {
            font-size: 14px;
            color: #666;
            margin-bottom: 10px;
        }
    </style>
</head>
<body>
<header class="header w">
    <div class="logo">
        <h1><a href="/index/">é¦™æ¸¯å¤©æ°”é¢„æµ‹å¯è§†åŒ–ç³»ç»Ÿ</a></h1>
    </div>
</header>
<div class="container">
    <div class="row">
        <div class="col-md-12">
            <ul class="nav nav-sidebar">
                <li><a href="/index/">é¦–é¡µ</a></li>
                <li class="active"><a href="/weather_forecast/" class="zi" style="color:black">å¤©æ°”é¢„æµ‹</a></li>
                <li><a href="/wind_speeds/">é£é€Ÿåˆ†æ</a></li>
                <li><a href="/rose/">é£å‘åˆ†æ</a></li>
            </ul>
        </div>
    </div>

    <div class="row">
        <div class="col-md-12">
            <div class="loading-status">
                <div>
                    <span id="status-indicator" class="status-indicator status-loading"></span>
                    <span id="status-text">æ•°æ®åŠ è½½ä¸­...</span>
                </div>
                <div id="data-stats" class="text-muted"></div>
            </div>
        </div>
    </div>
    <!-- æ§åˆ¶é¢æ¿ -->
    <div class="row">
        <div class="col-md-12">
            <div class="station-controls">
                <div class="form-group">
                    <label for="station-select">é€‰æ‹©æ°”è±¡ç«™:</label>
                    <select class="form-control" id="station-select">
                        <option value="æ²™ç”°">æ²™ç”°</option>
                        <option value="é•·æ´²">é•·æ´²</option>
                        <option value="èµ¤é±²è§’">èµ¤é±²è§’</option>
                        <option value="é¦™æ¸¯å¤©æ–‡å°">é¦™æ¸¯å¤©æ–‡å°</option>
                        <option value="é»ƒç«¹å‘">é»ƒç«¹å‘</option>
                        <option value="å°‡è»æ¾³">å°‡è»æ¾³</option>
                        <option value="æµæµ®å±±">æµæµ®å±±</option>
                        <option value="åªæ´²">åªæ´²</option>
                        <option value="çŸ³å´—">çŸ³å´—</option>
                        <option value="è¥¿è²¢">è¥¿è²¢</option>
                        <option value="æ‰“é¼“å¶º">æ‰“é¼“å¶º</option>
                        <option value="å¤§åŸ”">å¤§åŸ”</option>
                        <option value="å±¯é–€">å±¯é–€</option>
                        <option value="é’è¡£">é’è¡£</option>
                        <option value="æ©«ç€¾å³¶">æ©«ç€¾å³¶</option>
                        <option value="ä¸Šæ°´">ä¸Šæ°´</option>
                        <option value="æ‰¿å•Ÿé“å¤šåŠŸèƒ½æ™ºæ…§ç‡ˆæŸ±">æ‰¿å•Ÿé“å¤šåŠŸèƒ½æ™ºæ…§ç‡ˆæŸ±</option>
                        <option value="è§€å¡˜å¸‚ä¸­å¿ƒå¤šåŠŸèƒ½æ™ºæ…§ç‡ˆæŸ±">è§€å¡˜å¸‚ä¸­å¿ƒå¤šåŠŸèƒ½æ™ºæ…§ç‡ˆæŸ±</option>
                        <option value="æ—ºè§’ç©ºæ°£è³ªç´ ç›£æ¸¬ç«™">æ—ºè§’ç©ºæ°£è³ªç´ ç›£æ¸¬ç«™</option>
                        <option value="å¤©æ˜Ÿç¢¼é ­(å°–æ²™å’€)">å¤©æ˜Ÿç¢¼é ­(å°–æ²™å’€)</option>
                        <option value="å¤§ç’°å±±å…¬åœ’">å¤§ç’°å±±å…¬åœ’</option>
                        <option value="å•Ÿå¾·å·¥æ¥­è²¿æ˜“å¤§æ¨“">å•Ÿå¾·å·¥æ¥­è²¿æ˜“å¤§æ¨“</option>
                        <option value="é¦™æ¸¯ä¸­æ–‡å¤§å­¸(å¤§å­¸ç«™)">é¦™æ¸¯ä¸­æ–‡å¤§å­¸(å¤§å­¸ç«™)</option>
                        <option value="é¦™æ¸¯ä¸­æ–‡å¤§å­¸(ä¼å®œå­«æ›¸é™¢)">é¦™æ¸¯ä¸­æ–‡å¤§å­¸(ä¼å®œå­«æ›¸é™¢)</option>
                        <option value="ä¿è‰¯å±€èƒ¡å¿ ä¸­å­¸">ä¿è‰¯å±€èƒ¡å¿ ä¸­å­¸</option>
                        <option value="é¦™æ¸¯æµ·äº‹åšç‰©é¤¨">é¦™æ¸¯æµ·äº‹åšç‰©é¤¨</option>
                        <option value="ç¶­å¤šåˆ©äºå…¬åœ’">ç¶­å¤šåˆ©äºå…¬åœ’</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="days-select">é¢„æµ‹å¤©æ•°:</label>
                    <select class="form-control" id="days-select">
                        <option value="7">7å¤©</option>
                    </select>
                </div>
                <button id="refresh-btn" class="btn btn-primary">è·å–é¢„æŠ¥</button>
            </div>
        </div>
    </div>

    <!-- æ—¥æœŸé€‰é¡¹å¡ -->
    <div class="row">
        <div class="col-md-12">
            <ul class="nav nav-tabs" id="day-tabs">
                <li class="active"><a href="#day-0" data-toggle="tab">ç¬¬1å¤©</a></li>
                <!-- å…¶ä»–æ—¥æœŸæ ‡ç­¾å°†é€šè¿‡JSåŠ¨æ€ç”Ÿæˆ -->
            </ul>
        </div>
    </div>

    <!-- å›¾è¡¨å®¹å™¨ -->
    <div class="row">
        <div class="col-md-12">
            <h3 class="section-title">å¤©æ°”é¢„æµ‹</h3>
            <div class="data-info" id="weather-info"></div>
            <div class="chart-container" id="weather-chart"></div>
        </div>
    </div>
</div>

<script>
    $(document).ready(function () {
        // çŠ¶æ€ç®¡ç†å‡½æ•°
        function updateStatus(status, message, stats = '') {
            const indicator = document.getElementById('status-indicator');
            const text = document.getElementById('status-text');
            const statsEl = document.getElementById('data-stats');

            indicator.className = 'status-indicator';

            switch (status) {
                case 'loading':
                    indicator.classList.add('status-loading');
                    text.textContent = message || 'æ•°æ®åŠ è½½ä¸­...';
                    statsEl.textContent = '';
                    break;
                case 'success':
                    indicator.classList.add('status-success');
                    text.textContent = message || 'æ•°æ®åŠ è½½å®Œæˆ';
                    statsEl.textContent = stats;
                    break;
                case 'error':
                    indicator.classList.add('status-error');
                    text.textContent = message || 'æ•°æ®åŠ è½½å¤±è´¥';
                    statsEl.textContent = '';
                    break;
            }
        }

        // è·å–é¢„æŠ¥æ•°æ®
        $('#refresh-btn').on('click', function () {
            const station = $('#station-select').val();
            const days = $('#days-select').val();

            updateStatus('loading', 'æ­£åœ¨åŠ è½½å¤©æ°”æ•°æ®...');

            $.ajax({
                url: '/api/weather_forecasts',
                data: {station: station, days: days},
                method: 'GET',
                success: function (response) {
                    if (response.status === 'success') {
                        renderWeatherData(response.data);
                        updateStatus('success', 'æ•°æ®åŠ è½½å®Œæˆ',
                            `æ›´æ–°æ—¶é—´: ${new Date().toLocaleString()} | ç«™ç‚¹: ${station} | å¤©æ•°: ${days}`);
                    } else {
                        updateStatus('error', response.message || 'è·å–æ•°æ®å¤±è´¥');
                    }
                },
                error: function () {
                    updateStatus('error', 'è¯·æ±‚å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥');
                }
            });
        });

        // æ¸²æŸ“å¤©æ°”æ•°æ®
        function renderWeatherData(data) {
            if (!data || data.length === 0) {
                updateStatus('error', 'æ²¡æœ‰æ‰¾åˆ°é¢„æŠ¥æ•°æ®');
                return;
            }

            // ç”Ÿæˆæ—¥æœŸé€‰é¡¹å¡
            const $tabs = $('#day-tabs');
            $tabs.empty();

            data.forEach((dayData, index) => {
                const activeClass = index === 0 ? 'active' : '';
                $tabs.append(`
                <li class="${activeClass}">
                    <a href="#day-${index}" data-toggle="tab">${dayData.date}</a>
                </li>
            `);
            });

            // åˆå§‹åŒ–ç¬¬ä¸€ä¸ªæ—¥æœŸçš„å›¾è¡¨
            renderDayChart(data[0]);

            // é€‰é¡¹å¡åˆ‡æ¢äº‹ä»¶
            $('a[data-toggle="tab"]').on('shown.bs.tab', function (e) {
                const dayIndex = parseInt($(e.target).attr('href').split('-')[1]);
                renderDayChart(data[dayIndex]);
            });
        }

        // æ¸²æŸ“å•æ—¥å¤©æ°”å›¾è¡¨
        function renderDayChart(dayData) {
            const chart = echarts.init(document.getElementById('weather-chart'));

            // å‡†å¤‡æ•°æ®
            const hours = [];
            const weatherData = [];

            for (let h = 0; h < 24; h++) {
                const hourKey = h.toString().padStart(2, '0');
                const weather = dayData.hourly_data[hourKey] || 'æœªçŸ¥';

                hours.push(`${hourKey}:00`);
                weatherData.push({
                    value: getWeatherValue(weather),
                    weather: weather,
                    hour: `${hourKey}:00`
                });
            }

            // å›¾è¡¨é…ç½®ï¼ˆæ·»åŠ äº†æ¸å˜è‰²ï¼‰
            const option = {
                title: {
                    text: `${dayData.station} - ${dayData.date}`,
                    left: 'center'
                },
                tooltip: {
                    trigger: 'axis',
                    formatter: function (params) {
                        const data = params[0].data;
                        return `
                        <strong>æ—¶é—´:</strong> ${data.hour}<br/>
                        <strong>å¤©æ°”:</strong> ${data.weather}<br/>
                        <div style="font-size:24px;text-align:center">${getWeatherIcon(data.weather)}</div>
                    `;
                    }
                },
                grid: {
                    left: '3%',
                    right: '4%',
                    bottom: '3%',
                    containLabel: true
                },
                xAxis: {
                    type: 'category',
                    data: hours,
                    axisLabel: {
                        interval: 2,
                        rotate: 45
                    }
                },
                yAxis: {
                    type: 'value',
                    min: 0,
                    max: 10,
                    axisLabel: {
                        formatter: function (value) {
                            return getWeatherByValue(value);
                        }
                    },
                    splitLine: {
                        show: false
                    }
                },
                visualMap: {
                    show: false,
                    top: 10,
                    right: 10,
                    pieces: [
                        {min: 8, max: 10, color: '#FFD700'},  // é˜³å…‰å……æ²› - é‡‘è‰²
                        {min: 6, max: 8, color: '#FFA500'},   // å¤©è‰²è‰¯å¥½ - æ©™è‰²
                        {min: 4, max: 6, color: '#87CEEB'},    // å¤šäº‘ - å¤©è“è‰²
                        {min: 2, max: 4, color: '#1E90FF'},   // é˜´å¤© - é“å¥‡è“
                        {min: 0, max: 2, color: '#8B008B'}     // é›¨ - æ·±ç´«è‰²
                    ],
                    outOfRange: {
                        color: '#999'
                    }
                },
                series: [{
                    name: 'å¤©æ°”å˜åŒ–',
                    type: 'line',
                    symbol: 'circle',
                    symbolSize: 12,
                    lineStyle: {
                        width: 3,
                        shadowColor: 'rgba(0, 0, 0, 0.2)',
                        shadowBlur: 10,
                        shadowOffsetY: 5
                    },
                    itemStyle: {
                        borderWidth: 2,
                        borderColor: '#fff'
                    },
                    data: weatherData,
                    markLine: {
                        silent: true,
                        data: [{
                            type: 'average',
                            name: 'å¹³å‡',
                            lineStyle: {
                                color: '#FF6347',
                                width: 2,
                                type: 'dashed'
                            },
                            label: {
                                position: 'end',
                                formatter: 'å¹³å‡',
                                color: '#FF6347'
                            }
                        }]
                    }
                }]
            };

            chart.setOption(option);

            // æ›´æ–°ä¿¡æ¯æ˜¾ç¤º
            document.getElementById('weather-info').textContent =
                `ç«™ç‚¹: ${dayData.station} | æ—¥æœŸ: ${dayData.date} | å¤©æ°”å˜åŒ–è¶‹åŠ¿`;

            // çª—å£å¤§å°å˜åŒ–æ—¶é‡æ–°è°ƒæ•´å›¾è¡¨
            $(window).on('resize', function () {
                chart.resize();
            });

            return chart;
        }

        // è¾…åŠ©å‡½æ•° - è·å–å¤©æ°”å¯¹åº”çš„æ•°å€¼
        function getWeatherValue(weather) {
            const weatherMap = {
                'é˜³å…‰å……æ²›': 10,
                'å¤©è‰²è‰¯å¥½': 9,
                'å¤©è‰²å¤§è‡´è‰¯å¥½': 8,
                'é—´æœ‰é˜³å…‰': 7,
                'çŸ­æš‚é˜³å…‰': 6,
                'å¤§è‡´å¤šäº‘': 5,
                'å¤šäº‘': 4,
                'é˜´å¤©': 3,
                'å¾®é›¨': 2,
                'å°é›¨': 1,
                'å¤§é›¨': 0,
                'æœªçŸ¥': 5
            };
            return weatherMap[weather] || 5;
        }

        // è¾…åŠ©å‡½æ•° - æ ¹æ®æ•°å€¼è·å–å¤©æ°”
        function getWeatherByValue(value) {
            const weathers = {
                10: 'é˜³å…‰å……æ²›',
                9: 'å¤©è‰²è‰¯å¥½',
                8: 'å¤©è‰²å¤§è‡´è‰¯å¥½',
                7: 'é—´æœ‰é˜³å…‰',
                6: 'çŸ­æš‚é˜³å…‰',
                5: 'å¤§è‡´å¤šäº‘',
                4: 'å¤šäº‘',
                3: 'é˜´å¤©',
                2: 'å¾®é›¨',
                1: 'å°é›¨',
                0: 'å¤§é›¨'
            };
            return weathers[Math.round(value)] || 'æœªçŸ¥';
        }

        // è¾…åŠ©å‡½æ•° - è·å–å¤©æ°”å›¾æ ‡
        function getWeatherIcon(weather) {
            const icons = {
                'é˜³å…‰å……æ²›': 'â˜€ï¸',
                'å¤©è‰²è‰¯å¥½': 'ğŸŒ¤ï¸',
                'å¤©è‰²å¤§è‡´è‰¯å¥½': 'â›…',
                'é—´æœ‰é˜³å…‰': 'ğŸŒ¥ï¸',
                'çŸ­æš‚é˜³å…‰': 'ğŸŒ¤ï¸',
                'å¤§è‡´å¤šäº‘': 'â˜ï¸',
                'å¤šäº‘': 'â˜ï¸',
                'é˜´å¤©': 'â˜ï¸',
                'å¾®é›¨': 'ğŸŒ§ï¸',
                'å°é›¨': 'ğŸŒ§ï¸',
                'å¤§é›¨': 'ğŸŒ§ï¸',
                'æœªçŸ¥': 'â“'
            };
            return icons[weather] || 'â“';
        }

        // é»˜è®¤åŠ è½½æ•°æ®
        $('#refresh-btn').click();
    });
</script>
</body>
</html>